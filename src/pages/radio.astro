---
import { PUBLIC_RADIO_URL } from "astro:env/client"
import BaseLayout from "@/layouts/base.astro"
import List from "@/components/radioList.astro"

const pageTitle = "EdMateo's Radio"
const pageDescription = "The most autistic music at EdMateo's Radio"
const radioLive = `${PUBLIC_RADIO_URL}/live`
---

<BaseLayout {pageTitle} {pageDescription}>
  <div class="radio-player">
    <img src="/static/radio.gif" alt="Radio animation" />
    <div class="radio-box">
      <p id="radioSong" class="song-title">Espera...</p>
      <audio id="radio-audio" controls style="width: 100%;">
        <source src={radioLive} type="audio/mpeg" />
        Tu navegador no soporta el elemento de audio.
      </audio>
      <marquee>{pageDescription}</marquee>
    </div>
  </div>

  <p><b>EdMateo's Radio</b> es un proyecto bien autista que he creado para compartir mis gustos musicales paupérrimos al internet. Si te gusta la mierda, esto es lo que deberías escuchar en lugar de seguir pagando la suscripción del <a href="https://stallman.org/spotify.html"><b>MALDITO</b> Spotify</a>. La radio está abierta a todo el mundo, no debes pagar ni nada; este proyecto lo mantengo como a un hijo (ambos igual de inútiles).</p>
  <p>Si no quieres escuchar desde este sitio web, también puedes reproducir la radio directamente desde cualquier reproductor multimedia que pueda reproducir por el <i>protocolo http</i> (AIMP, vlc, mpv, etc.). Solo pon la url <a href={radioLive}><b>{radioLive}</b></a> en tu reproductor, o en su defecto, abre el link directamente en tu navegador.</p>

  <h2>Programación Estimada</h2>
  <p>La programación de la radio está dividida en <i>6 bloques</i>, cada uno asociado a un momento del día, reproducirán una playlist en aleatorio hasta que se pase al siguiente. <b>LA ZONA HORARIA ES UTC-5</b> </p>

  {[
    ["Amanecer (4:00 - 6:00)", "sunrise"],
    ["Mañana (6:00 - 11:30)", "morning"],
    ["Tarde (11:30 - 17:30)", "afternoon"],
    ["Noche (17:30 - 00:00)", "night"],
    ["Madrugada (00:00 - 3:00)", "lateNight"]
  ].map(([title, data]) => (
    <details><summary><b>{title}</b></summary><List data={data} /></details>
  ))}

  <details>
    <summary><b>C U R S E D (03:00 - 4:00)</b></summary>
    <p>Aquí es un poco diferente... <strong>Ustedes</strong> tendrán que descubrir por su propia cuenta qué canción está sonando. Si saben de qué canción se trata, <a href="/about#contacto">ya saben donde decírmelo</a>. Las canciones encontradas se pondrán acá, mucha suerte. <b class="green">:)</b></p>
  </details>
</BaseLayout>

<script>
  import { PUBLIC_RADIO_URL } from "astro:env/client"

  const fetchRadioSong = async () => {
    try {
      const res = await fetch(`${PUBLIC_RADIO_URL}/status-json.xsl`);
      const { icestats: { source } } = await res.json();
      const sources = Array.isArray(source) ? source : [source];
      const getTitle = (src) => src?.title?.trim() || '';

      let title = getTitle(sources.find(s => s.listenurl.includes('/live')));
      if (!title) {
        const stream = sources.find(s => s.listenurl.includes('/stream'));
        if (stream?.title) {
          const [artist, song] = stream.title.split(' - ');
          title = song && artist ? `${song.trim()} - ${artist.trim()}` : stream.title;
        }
      }

      document.getElementById('radioSong').textContent = `Sonando: ${title || 'Nada'}`;
    } catch (err) {
      console.error('Error fetching radio song:', err);
      document.getElementById('radioSong').textContent = 'Error fetching song information';
    }
  };

  fetchRadioSong();
  setInterval(fetchRadioSong, 10000);
</script>

<style>
  .radio-player {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .radio-player img {
    width: 180px;
    height: auto;
  }

  .radio-box {
    display: inline-block;
    width: 300px;
    margin-top: 20px;
  }

  .song-title {
    margin: 5px 0;
    font-weight: bold;
  }

  marquee {
    color: #bdae93;
    font-size: 14px;
    margin-top: 10px;
    display: block;
    width: 100%;
  }
</style>
